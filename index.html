<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bob's Adventure Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #f7f7f7;
      font-family: Arial, sans-serif;
      overflow: hidden;
      transition: background 0.3s;
    }
    #introScreen {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #333;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2;
    }
    #introScreen h1 { font-size: 36px; margin-bottom: 10px; }
    #introScreen p { font-size: 16px; margin: 4px 0; }
    #usernameInput {
      margin-top: 15px;
      padding: 8px;
      font-size: 18px;
      width: 220px;
      border-radius: 4px;
      border: none;
      outline: none;
    }
    #startButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #4caf50;
      color: white;
      transition: background-color 0.3s;
    }
    #startButton:hover:not(:disabled) {
      background-color: #45a049;
    }
    #startButton:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    #playerNameDisplay {
      text-align: center;
      font-size: 20px;
      margin-top: 20px;
      color: #222;
      min-height: 28px;
      font-weight: bold;
    }
    #game {
      position: relative;
      width: 800px;
      height: 200px;
      margin: 20px auto;
      background: #fff;
      border: 2px solid #333;
      transition: background 0.3s;
      overflow: hidden;
      touch-action: manipulation;
    }
    .cloud {
      position: absolute;
      width: 100px;
      height: 50px;
      background: rgba(255,255,255,0.9);
      border-radius: 25px;
      box-shadow: 10px 10px 10px rgba(0,0,0,0.1);
      will-change: transform;
      transition: background 0.3s, box-shadow 0.3s;
    }
    #scoreboard {
      text-align: center;
      margin-top: 10px;
      font-size: 20px;
      color: black;
      transition: color 0.3s;
    }
    #restartButton {
      display: none;
      margin: 10px auto;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    #leaderboard {
      text-align: center;
      margin-top: 15px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    #leaderboard h3 {
      margin-bottom: 5px;
    }
    #leaderboardList {
      padding-left: 0;
      list-style-position: inside;
    }
    #updateLog {
      text-align: center;
      margin-top: 12px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    #updateLogList {
      list-style-position: inside;
      padding-left: 0;
      margin-top: 8px;
      display: none; /* hidden by default, toggled by button */
    }
    #updateLogButton {
      padding: 8px 12px;
      margin-top: 8px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background: lightgreen;
      color: #000;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      transition: background-color 0.3s;
    }
    #updateLogButton:hover {
      background-color: #90ee90;
    }
    #bob {
      position: absolute;
      bottom: 0;
      left: 50px;
      width: 24px;
      height: 24px;
      background: black;
      image-rendering: pixelated;
      box-shadow:
        8px 0 black,
        16px 0 black,
        0 -8px black,
        0 -16px black,
        8px -8px black,
        -8px 0 black,
        -8px -8px black;
      transition: background 0.3s, box-shadow 0.3s;
    }
    #cactus {
      position: absolute;
      bottom: 0;
      width: 16px;
      height: 40px;
      background: green;
      right: 0;
      image-rendering: pixelated;
      box-shadow:
        8px 0 green,
        -8px 0 green,
        0 -8px green,
        0 -16px green,
        -8px -8px green,
        8px -8px green;
      transition: background 0.3s, box-shadow 0.3s;
    }

    @media (hover: none) and (pointer: coarse) {
      #introScreen p {
        display: none;
      }
    }
    #updateLogModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #modalContent {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      color: #222;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      text-align: center;
    }

    #modalContent h2 {
      margin-top: 0;
      margin-bottom: 15px;
    }

    #modalContent button {
      margin-top: 20px;
      padding: 8px 16px;
      cursor: pointer;
      border: none;
      background-color: #4caf50;
      color: white;
      border-radius: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="introScreen">
    <h1>Bob's Adventure</h1>
    <p>Enter your username to start:</p>
    <input id="usernameInput" type="text" placeholder="Your username" maxlength="15" />
    <button id="startButton" disabled>Start Game</button>
    <p style="margin-top:20px;">Press <b>Space</b> to Jump</p>
    <p>Hold longer = higher jump</p>
    <p>Speeds up every 10 seconds</p>
    <p>Reverse colors every 750 points</p>
  </div>

  <div id="playerNameDisplay"></div>

  <div id="game"></div>

  <div id="scoreboard">
    Score: <span id="score">0</span> | High Score: <span id="highScore">0</span>
  </div>

  <div id="leaderboard">
    <h3>üèÜ Leaderboard (Top 10)</h3>
    <ol id="leaderboardList"></ol>
  </div>

  <div id="updateLog">
    <button id="updateLogButton">üìú Show Update Log</button>
    <ul id="updateLogList">
      <li>v1.3 - Update Log toggle button & High Score display</li>
      <li>v1.2 - Added Top 10 Leaderboard & Update Log</li>
      <li>v1.1 - Color reverse every 750 points</li>
      <li>v1.0 - Initial release with jump power mechanic</li>
    </ul>
  </div>

  <div style="text-align:center;">
    <button id="restartButton">Restart</button>
  </div>

  <!-- Modal for Update Log -->
  <div id="updateLogModal">
    <div id="modalContent">
      <h2>Update Log</h2>
      <ul id="modalUpdateLogList">
        <li>v1.3 - Update Log toggle button & High Score display</li>
        <li>v1.2 - Added Top 10 Leaderboard & Update Log</li>
        <li>v1.1 - Color reverse every 750 points</li>
        <li>v1.0 - Initial release with jump power mechanic</li>
      </ul>
      <button id="closeModalBtn">Close</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Firebase config & init
    const firebaseConfig = {
      apiKey: "AIzaSyBRj8lE9GbcpOciO2A0ZqAlqCU-_gm0bDs",
      authDomain: "bob-s-adventure-c1713.firebaseapp.com",
      projectId: "bob-s-adventure-c1713",
      storageBucket: "bob-s-adventure-c1713.appspot.com",
      messagingSenderId: "340195000584",
      appId: "1:340195000584:web:04203c457533be32e4ecbd",
      measurementId: "G-XJ2B4N748D"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();
  </script>

  <script>
    // Elements
    const game = document.getElementById('game');
    const scoreSpan = document.getElementById('score');
    const highScoreSpan = document.getElementById('highScore');
    const intro = document.getElementById('introScreen');
    const startBtn = document.getElementById('startButton');
    const restartBtn = document.getElementById('restartButton');
    const usernameInput = document.getElementById('usernameInput');
    const playerNameDisplay = document.getElementById('playerNameDisplay');
    const leaderboardList = document.getElementById('leaderboardList');
    const updateLogButton = document.getElementById('updateLogButton');
    const updateLogModal = document.getElementById('updateLogModal');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let score = 0;
    let highScore = 0;
    let bob, cactus;
    let isJumping = false;
    let cactusSpeed = 5, gameStart = 0, cactusX = 800;
    let colorReversed = false, lastColorFlip = 0, gameRunning = false;
    let username = '';

    // Check if username stored in localStorage and auto-start game
    function checkStoredUser() {
      const storedUser = localStorage.getItem('bobGameUsername');
      if (storedUser) {
        username = storedUser;
        usernameInput.value = username;
        usernameInput.disabled = true;
        startBtn.disabled = true;
        playerNameDisplay.textContent = `Player: ${username}`;
        intro.style.display = 'none';

        // Load personal high score
        highScore = parseInt(localStorage.getItem(`highscore_${username}`)) || 0;
        highScoreSpan.textContent = highScore;

        // Setup and start game automatically
        setupScene();
        score = 0;
        scoreSpan.textContent = 0;
        gameStart = Date.now();
        cactusX = 800;
        restartBtn.style.display = 'none';
        gameRunning = true;
        requestAnimationFrame(updateFrame);
      } else {
        usernameInput.disabled = false;
        startBtn.disabled = true;
        playerNameDisplay.textContent = '';
        intro.style.display = 'flex';
      }
    }

    // Enable start button only if username input not empty and input not disabled
    usernameInput.addEventListener('input', () => {
      if (!usernameInput.disabled) {
        startBtn.disabled = usernameInput.value.trim() === '';
      }
    });

    // Setup game scene (bob, cactus, clouds)
    function setupScene() {
      game.innerHTML = '';
      bob = document.createElement('div');
      bob.id = 'bob';
      bob.style.bottom = '0px';
      game.appendChild(bob);

      cactus = document.createElement('div');
      cactus.id = 'cactus';
      cactus.style.right = (Math.random() * 400) + 'px';
      game.appendChild(cactus);

      for (let i = 0; i < 4; i++) spawnCloud();
    }

    function spawnCloud() {
      const c = document.createElement('div');
      c.className = 'cloud';
      c.style.top = `${20 + Math.random() * 60}px`;
      c.style.transform = `translateX(${800 + Math.random() * 200}px)`;
      game.appendChild(c);
    }

    function jump(power = 1) {
      if (isJumping) return;
      isJumping = true;

      const base = 0;
      const height = base + (60 + power * 60);
      let pos = base;

      const up = setInterval(() => {
        pos += 6;
        bob.style.bottom = pos + 'px';
        if (pos >= height) {
          clearInterval(up);
          const down = setInterval(() => {
            pos -= 6;
            bob.style.bottom = pos + 'px';
            if (pos <= base) {
              clearInterval(down);
              isJumping = false;
              bob.style.bottom = '0px';
            }
          }, 20);
        }
      }, 20);
    }

    // Main game loop update
    function updateFrame() {
      if (!gameRunning) return;

      const elapsed = Date.now() - gameStart;
      cactusSpeed = 5 + Math.floor(elapsed / 10000) * 1.5;
      score++;
      scoreSpan.textContent = score;

      if (score > highScore) {
        highScoreSpan.textContent = score;
      } else {
        highScoreSpan.textContent = highScore;
      }

      cactusX -= cactusSpeed;
      if (cactusX < -40) cactusX = 800;
      cactus.style.right = (800 - cactusX) + 'px';

      document.querySelectorAll('.cloud').forEach(c => {
        const m = c.style.transform.match(/translateX\((.*)px/);
        let x = (m ? parseFloat(m[1]) : 800) - cactusSpeed * 0.3;
        c.style.transform = `translateX(${x}px)`;
        if (x < -100) {
          c.remove();
          spawnCloud();
        }
      });

      checkCollision();
      checkColorCycle();
      requestAnimationFrame(updateFrame);
    }

    function checkCollision() {
      const dr = bob.getBoundingClientRect();
      const cr = cactus.getBoundingClientRect();

      const bobLeft = dr.left + 5;
      const bobRight = dr.right - 5;
      const bobTop = dr.top + 5;
      const bobBottom = dr.bottom - 5;

      const cactusLeft = cr.left + 3;
      const cactusRight = cr.right - 3;
      const cactusTop = cr.top + 3;
      const cactusBottom = cr.bottom - 3;

      if (
        bobRight > cactusLeft &&
        bobLeft < cactusRight &&
        bobBottom > cactusTop &&
        bobTop < cactusBottom
      ) {
        gameOver();
      }
    }

    function checkColorCycle() {
      if (Math.floor(score / 750) > lastColorFlip) {
        lastColorFlip = Math.floor(score / 750);
        toggleColors();
      }
    }

    function toggleColors() {
      colorReversed = !colorReversed;

      const setTextColors = (color) => {
        const textElements = [
          '#scoreboard',
          '#score',
          '#highScore',
          '#playerNameDisplay',
          '#leaderboard',
          '#leaderboardList',
          '#updateLogButton',
          '#updateLogList',
          '#restartButton',
          '#introScreen',
        ];
        textElements.forEach(selector => {
          const el = document.querySelector(selector);
          if (el) el.style.color = color;
        });
      };

      if (colorReversed) {
        document.body.style.background = '#000';
        game.style.background = '#222';
        setTextColors('#fff');

        bob.style.background = '#fff';
        bob.style.boxShadow = `
          8px 0 #fff,
          16px 0 #fff,
          0 -8px #fff,
          0 -16px #fff,
          8px -8px #fff,
          -8px 0 #fff,
          -8px -8px #fff
        `;

        cactus.style.background = '#90ee90';
        cactus.style.boxShadow = `
          8px 0 #90ee90,
          -8px 0 #90ee90,
          0 -8px #90ee90,
          0 -16px #90ee90,
          -8px -8px #90ee90,
          8px -8px #90ee90
        `;

        document.querySelectorAll('.cloud').forEach(c => {
          c.style.background = 'rgba(200, 200, 200, 0.9)';
          c.style.boxShadow = '10px 10px 10px rgba(255, 255, 255, 0.15)';
        });
      } else {
        document.body.style.background = '#f7f7f7';
        game.style.background = '#fff';
        setTextColors('#000');

        bob.style.background = 'black';
        bob.style.boxShadow = `
          8px 0 black,
          16px 0 black,
          0 -8px black,
          0 -16px black,
          8px -8px black,
          -8px 0 black,
          -8px -8px black
        `;

        cactus.style.background = 'green';
        cactus.style.boxShadow = `
          8px 0 green,
          -8px 0 green,
          0 -8px green,
          0 -16px green,
          -8px -8px green,
          8px -8px green
        `;

        document.querySelectorAll('.cloud').forEach(c => {
          c.style.background = 'rgba(255,255,255,0.9)';
          c.style.boxShadow = '10px 10px 10px rgba(0,0,0,0.1)';
        });
      }
    }

    // Game over logic
    function gameOver() {
  gameRunning = false;

  if (score > highScore) {
    highScore = score;
    localStorage.setItem(`highscore_${username}`, highScore);
  }

  updateLeaderboard(username, score);
  playerNameDisplay.textContent = `Game Over! Score: ${score}`;

  setTimeout(() => {
    // Reset colors to normal
    resetColorsToNormal();

    // Reset game variables
    score = 0;
    scoreSpan.textContent = '0';
    restartBtn.style.display = 'none';
    setupScene();
    gameStart = Date.now();
    cactusX = 800;
    gameRunning = true;
    playerNameDisplay.textContent = `Player: ${username}`;
    requestAnimationFrame(updateFrame);
  }, 1500);
}

function resetColorsToNormal() {
  if (colorReversed) {
    toggleColors();
  }
}

    restartBtn.addEventListener('click', () => {
      restartBtn.style.display = 'none';
      setupScene();
      score = 0;
      scoreSpan.textContent = 0;
      gameStart = Date.now();
      cactusX = 800;
      gameRunning = true;
      requestAnimationFrame(updateFrame);
    });

    // Start game button click handler
    startBtn.addEventListener('click', () => {
      username = usernameInput.value.trim();
      if (!username) return;

      localStorage.setItem('bobGameUsername', username);
      usernameInput.disabled = true;
      startBtn.disabled = true;
      playerNameDisplay.textContent = `Player: ${username}`;

      highScore = parseInt(localStorage.getItem(`highscore_${username}`)) || 0;
      highScoreSpan.textContent = highScore;

      intro.style.display = 'none';

      setupScene();
      score = 0;
      scoreSpan.textContent = 0;
      gameStart = Date.now();
      cactusX = 800;
      restartBtn.style.display = 'none';
      gameRunning = true;
      requestAnimationFrame(updateFrame);
    });

    // Jump on space key (hold duration changes jump power)
    let spaceDownTime = 0;
    document.body.addEventListener('keydown', e => {
      if (e.code === 'Space' && !isJumping && gameRunning) {
        if (spaceDownTime === 0) spaceDownTime = Date.now();
      }
    });
    document.body.addEventListener('keyup', e => {
      if (e.code === 'Space' && gameRunning) {
        if (spaceDownTime) {
          let holdDuration = (Date.now() - spaceDownTime) / 1000; // seconds
          spaceDownTime = 0;
          let power = Math.min(holdDuration, 1.5); // max power capped to 1.5s hold
          jump(power);
        }
      }
    });

    // Leaderboard update and display
    function updateLeaderboard(user, score) {
      const leaderboardRef = db.collection('leaderboard');

      leaderboardRef.doc(user).set({ score }, { merge: true })
        .then(() => {
          fetchLeaderboard();
        })
        .catch(err => {
          console.error('Error updating leaderboard:', err);
        });
    }

    function fetchLeaderboard() {
      const leaderboardRef = db.collection('leaderboard')
        .orderBy('score', 'desc')
        .limit(10);

      leaderboardRef.get().then(snapshot => {
        leaderboardList.innerHTML = '';
        snapshot.forEach(doc => {
          const li = document.createElement('li');
          li.textContent = `${doc.id}: ${doc.data().score}`;
          leaderboardList.appendChild(li);
        });
      });
    }

    // Update Log Toggle
    updateLogButton.addEventListener('click', () => {
      if (updateLogModal.style.display === 'flex') {
        updateLogModal.style.display = 'none';
      } else {
        updateLogModal.style.display = 'flex';
      }
    });

    closeModalBtn.addEventListener('click', () => {
      updateLogModal.style.display = 'none';
    });

    // Initialize on load
    checkStoredUser();
    fetchLeaderboard();

  </script>
</body>
</html>
