<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bob's Adventure Multiplayer with Locked Username</title>
  <style>
    /* Your existing styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #f7f7f7;
      font-family: Arial, sans-serif;
      overflow: hidden;
      transition: background 0.3s;
    }
    #introScreen {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #333;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2;
    }
    #introScreen h1 { font-size: 36px; margin-bottom: 10px; }
    #introScreen p { font-size: 16px; margin: 4px 0; }
    #usernameInput {
      margin-top: 15px;
      padding: 8px;
      font-size: 18px;
      width: 220px;
      border-radius: 4px;
      border: none;
      outline: none;
    }
    #startButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #4caf50;
      color: white;
      transition: background-color 0.3s;
    }
    #startButton:hover:not(:disabled) {
      background-color: #45a049;
    }
    #startButton:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    #playerNameDisplay {
      text-align: center;
      font-size: 20px;
      margin-top: 20px;
      color: #222;
      min-height: 28px;
      font-weight: bold;
    }
    #game {
      position: relative;
      width: 800px;
      height: 200px;
      margin: 20px auto;
      background: #fff;
      border: 2px solid #333;
      transition: background 0.3s;
      overflow: hidden;
      touch-action: manipulation;
    }
    .cloud {
      position: absolute;
      width: 100px;
      height: 50px;
      background: rgba(255,255,255,0.9);
      border-radius: 25px;
      box-shadow: 10px 10px 10px rgba(0,0,0,0.1);
      will-change: transform;
      transition: background 0.3s, box-shadow 0.3s;
    }
    #scoreboard {
      text-align: center;
      margin-top: 10px;
      font-size: 20px;
      color: black;
      transition: color 0.3s;
    }
    #restartButton {
      display: none;
      margin: 10px auto;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    #leaderboard {
      text-align: center;
      margin-top: 15px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    #leaderboard h3 {
      margin-bottom: 5px;
    }
    #leaderboardList {
      padding-left: 0;
      list-style-position: inside;
    }
    #bob {
      position: absolute;
      bottom: 0;
      left: 50px;
      width: 24px;
      height: 24px;
      background: black;
      image-rendering: pixelated;
      box-shadow:
        8px 0 black,
        16px 0 black,
        0 -8px black,
        0 -16px black,
        8px -8px black,
        -8px 0 black,
        -8px -8px black;
      transition: background 0.3s, box-shadow 0.3s;
    }
    #cactus {
      position: absolute;
      bottom: 0;
      width: 16px;
      height: 40px;
      background: green;
      right: 0;
      image-rendering: pixelated;
      box-shadow:
        8px 0 green,
        -8px 0 green,
        0 -8px green,
        0 -16px green,
        -8px -8px green,
        8px -8px green;
      transition: background 0.3s, box-shadow 0.3s;
    }

    @media (hover: none) and (pointer: coarse) {
      #introScreen p {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="introScreen">
    <h1>Bob's Adventure</h1>
    <p>Enter your username to start:</p>
    <input id="usernameInput" type="text" placeholder="Your username" maxlength="15" />
    <button id="startButton" disabled>Start Game</button>
    <p style="margin-top:20px;">Press <b>Space</b> to Jump</p>
    <p>Hold longer = higher jump</p>
    <p>Speeds up every 10 seconds</p>
    <p>Reverse colors every 750 points</p>
  </div>

  <div id="playerNameDisplay"></div>

  <div id="game"></div>

  <div id="scoreboard">
    Score: <span id="score">0</span>
  </div>

  <div id="leaderboard">
    <h3>üèÜ Leaderboard</h3>
    <ol id="leaderboardList"></ol>
  </div>

  <div style="text-align:center;">
    <button id="restartButton">Restart</button>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBRj8lE9GbcpOciO2A0ZqAlqCU-_gm0bDs",
      authDomain: "bob-s-adventure-c1713.firebaseapp.com",
      projectId: "bob-s-adventure-c1713",
      storageBucket: "bob-s-adventure-c1713.appspot.com",
      messagingSenderId: "340195000584",
      appId: "1:340195000584:web:04203c457533be32e4ecbd",
      measurementId: "G-XJ2B4N748D"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();
  </script>

  <script>
    const game = document.getElementById('game');
    const scoreSpan = document.getElementById('score');
    const intro = document.getElementById('introScreen');
    const startBtn = document.getElementById('startButton');
    const restartBtn = document.getElementById('restartButton');
    const usernameInput = document.getElementById('usernameInput');
    const playerNameDisplay = document.getElementById('playerNameDisplay');
    const leaderboardList = document.getElementById('leaderboardList');

    let score = 0;
    let bob, cactus;
    let isJumping = false, jumpStart = null;
    let cactusSpeed = 5, gameStart = 0, cactusX = 800;
    let colorReversed = false, lastColorFlip = 0, gameRunning = false;
    let username = '';

    // Load username from localStorage if exists
    window.onload = () => {
      const savedUsername = localStorage.getItem('bobGameUsername');
      if (savedUsername) {
        username = savedUsername;
        usernameInput.value = username;
        usernameInput.disabled = true;
        startBtn.disabled = true;
        intro.style.display = 'none';
        playerNameDisplay.textContent = `Player: ${username}`;
        startGame();
      }
    };

    usernameInput.addEventListener('input', () => {
      startBtn.disabled = usernameInput.value.trim() === '';
    });

    function setupScene() {
      game.innerHTML = '';
      bob = document.createElement('div');
      bob.id = 'bob';
      bob.style.bottom = '0px';
      game.appendChild(bob);

      cactus = document.createElement('div');
      cactus.id = 'cactus';
      cactus.style.right = '0px';
      game.appendChild(cactus);

      for (let i = 0; i < 4; i++) spawnCloud();
    }

    function spawnCloud() {
      const c = document.createElement('div');
      c.className = 'cloud';
      c.style.top = `${20 + Math.random() * 60}px`;
      c.style.transform = `translateX(${800 + Math.random() * 200}px)`;
      game.appendChild(c);
    }

    function jump(power = 1) {
      if (isJumping) return;
      isJumping = true;

      const base = 0;
      const height = base + (60 + power * 60);
      let pos = base;

      const up = setInterval(() => {
        pos += 6;
        bob.style.bottom = pos + 'px';
        if (pos >= height) {
          clearInterval(up);
          const down = setInterval(() => {
            pos -= 6;
            bob.style.bottom = pos + 'px';
            if (pos <= base) {
              clearInterval(down);
              isJumping = false;
              bob.style.bottom = '0px';
            }
          }, 20);
        }
      }, 20);
    }

    function updateFrame() {
      if (!gameRunning) return;

      const elapsed = Date.now() - gameStart;
      cactusSpeed = 5 + Math.floor(elapsed / 10000) * 1.5;
      score++;
      scoreSpan.textContent = score;

      cactusX -= cactusSpeed;
      if (cactusX < -40) cactusX = 800;
      cactus.style.right = (800 - cactusX) + 'px';

      document.querySelectorAll('.cloud').forEach(c => {
        let x = parseFloat(c.style.transform.match(/translateX\((.*)px/)[1]) - cactusSpeed * 0.3;
        c.style.transform = `translateX(${x}px)`;
        if (x < -100) {
          c.remove();
          spawnCloud();
        }
      });

      checkCollision();
      checkColorCycle();
      requestAnimationFrame(updateFrame);
    }

    function checkCollision() {
      const dr = bob.getBoundingClientRect();
      const cr = cactus.getBoundingClientRect();

      const bobLeft = dr.left + 5;
      const bobRight = dr.right - 5;
      const bobTop = dr.top + 5;
      const bobBottom = dr.bottom - 5;

      const cactusLeft = cr.left + 3;
      const cactusRight = cr.right - 3;
      const cactusTop = cr.top + 3;
      const cactusBottom = cr.bottom - 3;

      if (
        bobRight > cactusLeft &&
        bobLeft < cactusRight &&
        bobBottom > cactusTop &&
        bobTop < cactusBottom
      ) {
        gameOver();
      }
    }

    function checkColorCycle() {
      if (Math.floor(score / 750) > lastColorFlip) {
        lastColorFlip = Math.floor(score / 750);
        toggleColors();
      }
    }

    function toggleColors() {
      colorReversed = !colorReversed;
      if (colorReversed) {
        document.body.style.background = '#000';
        game.style.background = '#fff';
        document.getElementById('scoreboard').style.color = '#fff';
        document.querySelectorAll('.cloud').forEach(c => {
          c.style.background = 'rgba(200, 200, 200, 0.9)';
          c.style.boxShadow = '10px 10px 10px rgba(255, 255, 255, 0.15)';
        });
      } else {
        document.body.style.background = '#f7f7f7';
        game.style.background = '#fff';
        document.getElementById('scoreboard').style.color = '#000';
        document.querySelectorAll('.cloud').forEach(c => {
          c.style.background = 'rgba(255,255,255,0.9)';
          c.style.boxShadow = '10px 10px 10px rgba(0, 0, 0, 0.1)';
        });
      }
    }

    async function checkAndRegisterUsername(name) {
      const userRef = db.collection('users').doc(name);
      const doc = await userRef.get();

      if (doc.exists) {
        alert('This username is already taken. Please choose another one.');
        return false;
      } else {
        await userRef.set({ bestScore: 0 });
        return true;
      }
    }

    async function updateBestScore(name, newScore) {
      const userRef = db.collection('users').doc(name);
      const doc = await userRef.get();
      if (doc.exists) {
        const data = doc.data();
        if (newScore > data.bestScore) {
          await userRef.update({ bestScore: newScore });
        }
      }
    }

    function loadLeaderboard() {
      db.collection("users")
        .orderBy("bestScore", "desc")
        .limit(5)
        .get()
        .then((querySnapshot) => {
          leaderboardList.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const name = doc.id;
            const li = document.createElement('li');
            li.textContent = `${name}: ${data.bestScore}`;
            leaderboardList.appendChild(li);
          });
        })
        .catch((error) => {
          console.error("Error loading leaderboard: ", error);
        });
    }

    async function gameOver() {
      gameRunning = false;
      await updateBestScore(username, score);
      alert('Game Over! Your score: ' + score);
      restartBtn.style.display = 'inline-block';
      loadLeaderboard();
    }

    function restartGame() {
      score = 0;
      scoreSpan.textContent = score;
      cactusX = 800;
      cactusSpeed = 5;
      gameStart = Date.now();
      lastColorFlip = 0;
      colorReversed = false;
      gameRunning = true;
      document.body.style.background = '#f7f7f7';
      game.style.background = '#fff';
      document.getElementById('scoreboard').style.color = '#000';
      restartBtn.style.display = 'none';
      setupScene();
      requestAnimationFrame(updateFrame);
    }

    function startGame() {
      gameStart = Date.now();
      gameRunning = true;
      setupScene();
      loadLeaderboard();
      requestAnimationFrame(updateFrame);
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && jumpStart === null && gameRunning) {
        jumpStart = Date.now();
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.code === 'Space' && jumpStart !== null && gameRunning) {
        const held = Date.now() - jumpStart;
        jumpStart = null;
        jump(Math.min(held / 300, 1));
      }
    });

    // Mobile tap to jump (full power)
    game.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (!gameRunning || isJumping) return;
      jump(1);
    });

    startBtn.addEventListener('click', async () => {
      if (username) return; // already started
      const inputName = usernameInput.value.trim();
      if (!inputName) return;

      const available = await checkAndRegisterUsername(inputName);
      if (!available) return;  // Username taken, stop here

      username = inputName;
      localStorage.setItem('bobGameUsername', username);  // LOCK username locally
      intro.style.display = 'none';
      playerNameDisplay.textContent = `Player: ${username}`;
      usernameInput.disabled = true;
      startBtn.disabled = true;
      startGame();
    });

    restartBtn.addEventListener('click', () => {
      restartGame();
    });
  </script>
</body>
</html>
